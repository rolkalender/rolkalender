<!doctype html>
<html lang="en">
<head>
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>pistolkalender</title>
  <meta name="description" content="Rolkalender" />
  <style>
    model-viewer {
      width: 100%;
      height: 400px;
      background-color: transparent; 
      border-radius: 8px;
    }

      .poll-container {
        position: fixed;
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
        width: 220px;
        padding: 20px;
        background: rgba(37, 16, 79, 0.85);
        backdrop-filter: blur(8px);
        border: 1px solid #1e2b4a;
        border-radius: 16px;
        color: #fff;
        z-index: 40;
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      }
      .super-poll-title {
        margin: 0 0 4px 0;
        font-size: 20px;
        color: var(--red);
        text-align: center;
        font-weight: 900;
        letter-spacing: 1px;
      }
      .poll-title {
        margin: 0 0 12px 0;
        font-size: 16px;
        color: var(--gold);
        text-align: center;
        font-weight: bold;
      }
      /* voting buttons */
      .poll-opt {
        display: block;
        width: 100%;
        margin-bottom: 8px;
        padding: 8px;
        background: #4d68ac;
        border: none;
        border-radius: 8px;
        color: #fff;
        cursor: pointer;
        text-align: left;
        transition: 0.2s;
        font-size: 13px;
      }
      .poll-opt:hover { background: #3a4d80; }
      /* resultado */
      .poll-result { margin-bottom: 8px; font-size: 12px; }
      .poll-bar-bg {
        background: rgba(255,255,255,0.1);
        border-radius: 4px;
        height: 6px;
        margin-top: 4px;
        overflow: hidden;
      }
      .poll-bar-fill {
        height: 100%;
        background: var(--green);
        width: 0%;
        transition: width 1s ease;
      }
      .poll-meta { display: flex; justify-content: space-between; opacity: 0.8; }

      /* hide on small resolutions
      @media (max-width: 1300px) {
        .poll-container { display: none; }
      }
      */
      .mobile-widget-controls{
        display: none;
      }
      @media (max-width: 1300px){
        .mobile-widget-controls{
          display: flex;
          position: fixed;
          bottom: 20px;
          right: 20px;
          flex-direction: column;
          gap: 10px;
          z-index: 100;
        }
        .widget-btn{
          background: var(--card);
          border: 2px solid var(--gold);
          color: var(--gold);
          padding: 12px 16px;
          border-radius: 50px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0,0,0,0.5);
          transition: transform 0.2s;
        }
        .widget-btn:active {transform: scale(0.95);}
        /* mobile pol */
        .poll-container {
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          width: 90%;
          max-width: 350px;
          box-shadow: 0 0 0 100vmax rgba(0,0,0,0.7);
        }
        .poll-container.mobile-active{
          display: block;
          animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /* mobile weel */
        .rol-widget-container{
          display: none;
          position: fixed;
          top: 50%;
          left: 50%;
          right: auto;
          transform: translate(-50%, -50%);
          z-index: 101;
        }
        .rol-widget-container.mobile-active{
          display: block;
        }
        @keyframes moveRight{
          0% { transform: translate(-50%, -50%); opacity: 1;}
          100% {transform: translate(100vw, -50%); opacity: 0;}
        }
      }
      @keyframes popIn {
        from{opacity: 0; transform: translate(-50%, -45%) scale(0.9);}
        to {opacity: 1; transform: translate(-50%, -50%)scale(1);}
      }
    
    :root{
      --bg1:#06150e;
      --bg2:#0b2a1d;
      --card:#6b0f0f;
      --accent:#ffe8a3;
      --gold:#ffd97a;
      --lock:#8a4444;
      --red:#c81e1e;
      --green:#22c55e;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(circle at center, #164232 0%, #020805 100%);color:#eef3ff}
    header{max-width:980px;margin:0 auto;padding:28px 16px;text-align:center}
    header h1{margin:0 0 6px;font-size:clamp(28px,4vw,44px)}
    header p{margin:0;opacity:.9}
    .wrap{max-width:980px;margin:0 auto;padding:8px 16px 28px}

    .grid{display:grid;gap:14px;grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:600px){.grid{grid-template-columns:repeat(2,1fr)}}

    .door{position:relative;aspect-ratio:1/1;border-radius:16px;perspective:800px;isolation:isolate;box-shadow:0 10px 26px rgba(0,0,0,.35);transform:translateY(0);transition:transform .15s ease}
    .door:hover{transform:translateY(-2px)}
    .panel{pointer-events:none;position:absolute;inset:0;background:radial-gradient(140% 100% at 10% 10%, #9a1b1b, var(--card));border-radius:16px;border:1px solid rgba(255,255,255,.06)}
    .flap{pointer-events:none;position:absolute;inset:0;border-radius:16px;background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(0,0,0,.25));transform-origin:left center;transform:rotateY(0deg);transition:transform .8s cubic-bezier(.2,.8,.2,1), filter .3s ease}
    .door.open .flap{transform:rotateY(-160deg); filter:brightness(1.05)}
    .num{position:absolute;top:10px;left:10px;padding:6px 9px;border-radius:999px;background:rgba(0,0,0,.35);color:var(--gold);font-weight:700;letter-spacing:.3px;font-size:14px;z-index: 5}
    .label{
        position:absolute;
        bottom:0;
        left:0;
        right:0;
        padding:12px;
        background:linear-gradient(180deg,transparent,rgba(0,0,0,.55));
        font-size:14px;
        z-index: 5;
      }
    .door.locked .panel{filter:saturate(.6) brightness(.9)}
    .door.locked .label::after{content:" üîí "}

    .gift-wrap{position:absolute;inset:0;background:var(--red);border-radius:16px;z-index:4;transition:opacity .4s ease, transform .4s ease;display:flex;align-items:center;justify-content:center}
    .gift-wrap::before{content:"";position:absolute;width:20%;height:100%;background:var(--green);box-shadow:0 0 5px rgba(0,0,0,0.3)}
    .gift-wrap::after{content:"";position:absolute;height:20%;width:100%;background:var(--green);box-shadow:0 0 5px rgba(0,0,0,0.3)}
    .door.open .gift-wrap{opacity:0;transform:scale(1.1);pointer-events:none}

    button.reset{all:unset;position:absolute;inset:0;z-index:6;cursor:pointer;border-radius:16px;display:block;width:100%;height:100%}

    dialog{
        border:none;
        border-radius: 18px;
        max-width:min(1000px,95vw);
        padding:0;
        background:#141414;
        color:#fff;
        overflow:hidden;
        min-height: 600px;
    }
    .mbody{
        padding:16px;
        width:auto;
        overflow-y: auto;
        max-height: 80vh;
    }
    img,video,iframe{
      width:100%;
      height:auto;
      border-radius:10px
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .mhead{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;background:#eba76b;border-bottom:1px solid #581616}
    .mbody{padding:16px}
    .mtext{margin-top:12px;line-height:1.5;color:#ccd6f6}
    .btn{appearance:none;border:0;background:#2a3b66;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .btn:hover{filter:brightness(1.08)}
    .controls-group{display:flex;gap:8px}
    
    img,video,iframe{width:100%;height:auto;border-radius:10px}
    audio{width:100%}

    footer{opacity:.8;text-align:center;padding:20px;font-size:13px}

    #snowCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}
    .controls{position:fixed;left:12px;bottom:12px;z-index:50;background:#10182acc;border:1px solid #1e2b4a;padding:10px 12px;border-radius:12px;color:#fff;backdrop-filter:blur(6px);display:flex;gap:10px;align-items:center;flex-wrap:wrap;max-width:min(96vw,560px)}
    .controls label{display:flex;align-items:center;gap:6px;font-size:14px}
    .controls input[type=range]{width:140px}
    .ribbon{position:relative;display:inline-block;margin-top:10px;padding:6px 10px 6px 26px;background:linear-gradient(90deg,var(--green),#0da855);border-radius:999px;color:#08210f;font-weight:700}
    .ribbon::before{content:"üéÅ";position:absolute;left:6px;top:50%;transform:translateY(-50%)}
    .switch{appearance:none;width:42px;height:24px;background:#304063;border-radius:999px;position:relative;outline:none;cursor:pointer}
    .switch:before{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;background:#fff;border-radius:50%;transition:transform .2s ease}
    .switch:checked{background:#0da855}
    .switch:checked:before{transform:translateX(18px)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .controls{display:flex;flex-direction:column;align-items:stretch;gap:8px;max-width:240px}

    /* ROL THE WEEL */
    .rol-widget-container {
      position: fixed;
      top: 30%;
      right: 12%;
      transform: translateY(-50%);
      width: 300px;
      z-index: 45;
      text-align: center;
    }
    .speech-bubble {
      background: #fff;
      color: #000;
      padding: 14px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 12px;
      position: relative;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      font-family: 'Comic Sans MS', 'Comic Sans';
      min-height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .speech-bubble::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid #fff;
    }
    .the-wheel {
      width: 300px;
      height: 300px;
      cursor: pointer;
      transition: transform 0.2s ease;
      filter: drop-shadow(0 5px 15px rgba(0,0,0,0.5));
    }
    .the-wheel:hover {
      transform: scale(1.05);
    }
    
    /* js animations for roly */
    .rol-is-leaving {
      animation: moveRight 6s ease-in forwards;
      animation-delay: 8s;
    }
    .rol-is-spinning {
      animation: spinWheel 10s linear forwards;
    }
    @keyframes moveRight {
      0% { transform: translate(0, -50%); opacity: 1; }
      100% { transform: translate(120vw, -50%); opacity: 0; }
    }
    @keyframes spinWheel {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(4000deg); }
    }
    /* hide on small reso
    @media (max-width: 1300px) {
      .rol-widget-container { display: none; }
    }
    */



  </style>
</head>
<body>
  <div id="sidePoll" class="poll-container"></div>
  <div id="rolWidget" class="rol-widget-container">
    <img src="wheel/rol_dizzy.png" style="display:none;" alt="preload">
    <div id="rolBubble" class="speech-bubble">
      Hallo im Rol the Weel. Spin me to win a grand prize $$$!
    </div>
    <img id="rolWheel" src="wheel/rol_wheel.png" alt="Rol the Wheel" class="the-wheel">
  </div>
  <canvas id="snowCanvas" aria-hidden="true"></canvas>
  <div class="controls" role="group" aria-label="Site controls">
    <label>‚ùÑÔ∏è Snow
        <input id="snowRange" type="range" min="0" max="500" value="120" aria-label="Snowflake count">
        <span id="snowCount" class="mono">120</span>
    </label>

    <label>üéÖ Rol
        <input id="laughSwitch" type="checkbox" class="switch">
    </label>

    <label>üî´ Pistol
        <input id="emojiRange" type="range" min="0" max="300" value="0" aria-label="Emoji count">
        <span id="emojiCount" class="mono">0</span>
    </label>
  </div>


  <header>
    <h1>Gabdi's Rolkalender</h1>
    <p>A gabdition since olden days of gabdihundratalet.
    </p>
  </header>

  <div class="wrap">
    <div id="grid" class="grid" aria-live="polite"></div>
  </div>

  <dialog id="modal" aria-modal="true">
    <div class="mhead">
      <strong id="modalTitle">Treat</strong>
      <div class="controls-group">
        <button class="btn" id="narratorBtn" aria-label="Toggle Narration">
         <span id="narratorIcon">üîä</span> Mute gabbe üôÑ 
        </button>
        <button class="btn" id="closeBtn">Close</button>
      </div>
    </div>
    <div class="mbody" id="modalBody"></div>
  </dialog>

  <div class="mobile-widget-controls">
    <button id="mobilePollBtn" class="widget-btn" aria-label="Rol Pol">
      Rol Pol
    </button>
    <button id="mobileRolBtn" class="widget-btn" aria-label="Rol the Wheel">
      Rol the Weel
    </button>
  </div>

  


  <footer>¬© gabdihundrafyrtiofem - <span id="year"></span></footer>

  <audio id="jingle" preload="auto" src="jingle.mp3"></audio>
  <audio id="laugh" preload="auto" src="rol.mp3" loop></audio>
  <audio id="narrationPlayer" preload="auto"></audio>

  <script>
  const TREAT_DATA = [
    { 
      day: 1, 
      type: 'image', 
      title: "Picasso Art (Gabbe's Version)", 
      src: 'treats/day1.png',
      text: 'A festive art piece by Gablo Picassuh.',
      narration: 'narration/day1_narration.mp3'
    },
    {
      day: 2,
      type: 'image',
      title: "GOOBENG (David's Version)",
      src: 'goobeng.jpg',
      noLink: true,
      text: `
        <div style="margin-top: 10px;">
          <audio controls src="goobeng.mp3" style="width: 100%"></audio>
        </div>
        <p>Happy December 2nd! A festive, tropical song from David about his childhood area he holds dearest.</p>
      `,
    },
    {
      day: 3,
      type: 'youtube',
      title: "Christmas Gaming Montage (Suneet's version)",
      src: 'https://www.youtube.com/embed/-iaYLJMX2KU',
      text: "A festive gaming montage from the most epic gamer at Rolkalender Studios: suneet_p. Do they (gamers) know it's Christmas time? Let's find out! ",
      narration: 'narration/openlucka.mp3'
    },
    { 
      day: 4, 
      type: 'model', 
      title: "Critter Taxidermy (Victor's Version)", 
      src: 'treats/frankenFrog.blend2.glb',
      text: "Devastated by the tragic loss of his pet Fritjof (Named after Karl Fritjof Lager), Dr. Victor Baxter spent forty days and forty nights stitching her back together in a lab, resulting in a festive patchwork for us all to observe. ",
      narration: 'narration/day4.mp3' 
    },
    {
      day: 5,
      type: 'custom',
      title: "Gabe Smok & Gabe Smok duett",
      text: `
          <div style="width: 105vw; max-width: 700px; margin: 0 auto;">
              
              <div style="text-align: center; margin-bottom: 15px;">
                  <img src="treats/day5.png" style="max-width: 400px; width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
              </div>

              <div style="margin-top: 10px; text-align: center;">
                <audio id="day5-audio" controls src="treats/day5.mp3" style="width: 100%"></audio>
                
                <div style="height: 60px; display: flex; align-items: center; justify-content: center; margin-top: 10px;">
                  <button id="clap-btn" class="btn" style="display: none; transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); background: var(--gold); color: #000; font-weight: 800; font-size: 18px; padding: 12px 24px;">
                      üëè Join in on the clapping!
                  </button>
                </div>
                
                <audio id="clap-sfx" src="treats/clap.mp3"></audio>
              </div>
              <p>No description needed.</p>
          </div>
        `,
      specialFeature: 'clap' 
    },
    {
      day: 6,
      type: 'image',
      title: "Ein Tannenbaum (Julia's Version)",
      src: "treats/day6.jpg",
      text: "Rolkalenderns very own, precious christmas tree decorated by Julia, who seemingly was inspired by the decorating manner of a serial killer.",
      narration: "narration/tannenbaum.mp3"
    }
  ];

  const LOCK_TZ = 'Europe/Stockholm';
  const START_MONTH = 12;
  const TOTAL_DOORS = 24;
  const UNLOCK_HOUR = 18;

  // rol poll
  const POLL_CONFIG = {
    id: 'poll_pistol_1',
    question: "Who should be the mascot of Rolkalender 2025?",
    riggedWinnerIndex: 1,
    riggedPercentage: 55,
    options: [
      { text: "Santa Klaus", baseVotes: 42 },
      { text: "Rol the Wheel", baseVotes: 65 },
      { text: "ApeRol Spritz", baseVotes: 38 },
      { text: "Roland McPistoland", baseVotes: 12 }
    ]
  };

  function renderPoll() {
    const container = document.getElementById('sidePoll');
    if (!container) return;
    const userChoice = localStorage.getItem(POLL_CONFIG.id);
    container.innerHTML = `
        <h2 class="super-poll-title">ROL POL</h2>
        <h3 class="poll-title">${POLL_CONFIG.question}</h3>
    `;

    if (!userChoice) {
      POLL_CONFIG.options.forEach((opt, index) => {
        const btn = document.createElement('button');
        btn.className = 'poll-opt';
        btn.textContent = opt.text;
        btn.onclick = () => {
          localStorage.setItem(POLL_CONFIG.id, index);
          renderPoll();s
        };
        container.appendChild(btn);
      });
    } else {
      const totalBase = POLL_CONFIG.options.reduce((acc, o) => acc + o.baseVotes, 0) + 1; // +1 = user
      
      POLL_CONFIG.options.forEach((opt, index) => {
        const count = opt.baseVotes + (parseInt(userChoice) === index ? 1 : 0);
        const percent = Math.round((count / totalBase) * 100);
        
        const row = document.createElement('div');
        row.className = 'poll-result';
        row.innerHTML = `
          <div class="poll-meta">
            <span>${opt.text}</span>
            <span>${percent}%</span>
          </div>
          <div class="poll-bar-bg">
            <div class="poll-bar-fill" style="width: ${percent}%"></div>
          </div>
        `;
        container.appendChild(row);
      });

      const thanks = document.createElement('div');
      thanks.style.textAlign = 'center';
      thanks.style.opacity = '0.6';
      thanks.style.fontSize = '11px';
      thanks.style.marginTop = '12px';
      thanks.innerText = "Democracy manifested - thank you for voting!";
      container.appendChild(thanks);
    }
  }

  // call poll vid init()
  renderPoll();

  function todayInTZ(tz){
    const fmt = new Intl.DateTimeFormat('en-CA', { 
      timeZone: tz, 
      year:'numeric', 
      month:'2-digit', 
      day:'2-digit',
      hour: 'numeric',
      hourCycle: 'h23'
    });
    const parts = fmt.formatToParts(new Date());
    const get = k => parts.find(p=>p.type===k).value;
    return { y:+get('year'), m:+get('month'), d:+get('day'), h:+get('hour') };
  }
  function isUnlocked(day){
    const { m, d, h } = todayInTZ(LOCK_TZ);
    if (m !== START_MONTH) return false;
    if (d > day) return true;
    if (d == day) {
        return h>= UNLOCK_HOUR;
    }
    return false;
  }
  function el(tag, attrs={}, children=[]) {
    const e=document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=>{
      if (k==='class') e.className=v; else if (k.startsWith('on')) e.addEventListener(k.slice(2).toLowerCase(), v); else e.setAttribute(k,v);
    });
    (Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=> e.append(c.nodeType?c:document.createTextNode(c)));
    return e;
  }

  const modal = document.getElementById('modal');
  const modalBody = document.getElementById('modalBody');
  const modalTitle = document.getElementById('modalTitle');
  const narrationPlayer = document.getElementById('narrationPlayer');
  const narratorBtn = document.getElementById('narratorBtn');
  const narratorIcon = document.getElementById('narratorIcon');
  let lastOpenedCard = null;
  let isMuted = false;

  narratorBtn.onclick = () => {
    isMuted = !isMuted;
    narratorIcon.textContent = isMuted ? 'üîá' : 'üîä';
    if(isMuted) {
        narrationPlayer.pause();
    } else if (narrationPlayer.src && !narrationPlayer.paused) {
        
    } else if (narrationPlayer.src) {
        narrationPlayer.play().catch(()=>{});
    }
  };

  document.getElementById('closeBtn').onclick = () => {
    modalBody.querySelectorAll('audio, video').forEach(el => {
        el.pause();
        el.currentTime = 0;
    });
    narrationPlayer.pause();
    narrationPlayer.currentTime = 0;

    modalBody.querySelectorAll('iframe').forEach(f => {
        f.src = f.src; 
    });

    modal.close();
    if (lastOpenedCard) {
        setTimeout(() => lastOpenedCard.classList.remove('open'), 150);
    }
  };


  function showTreat(treat){
    modalTitle.textContent = treat.title || `Dag ${treat.day}`;
    modalBody.innerHTML = '';
    
    if (treat.type === 'image') {
      const img = el('img', { 
        alt: treat.title||'', 
        src: treat.src, 
        loading:'lazy',
        style: 'max-height: 70vh; width: auto; max-width: 100%; display: block; margin: 0 auto;' 
      });
      if (treat.noLink){
        modalBody.append(img);
      } else {
        const link = el('a', { href: treat.src, target: '_blank', title: 'Click to enjoy festivity in intended size' }, img);
        modalBody.append(link);
      }
    } else if (treat.type === 'audio') {
      modalBody.append(el('audio', { controls: true, src: treat.src }));
      modalBody.append(el('p', {}, el('a', { href: treat.src, download: '' })));
    } else if (treat.type === 'video') {
      const v = el('video', { controls: true, playsinline: true });
      v.append(el('source',{src:treat.src, type:'video/mp4'}));
      modalBody.append(v);
      modalBody.append(el('p', {}, el('a', { href: treat.src, download: '' })));
    } else if (treat.type === 'youtube') {
      modalBody.append(el('iframe', { 
        width: '100%',
        height:'auto',
        style: 'aspect-ratio: 16 / 9; min-height: 350px;',
        allow:'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture',
        allowfullscreen:'',
        src: treat.src
      }));
    } else if (treat.type === 'model') {
      modalBody.append(el('model-viewer', {
        src: treat.src,
        alt: treat.title || '3D model',
        'auto-rotate': '',
        'camera-controls': '',
        'autoplay': '',
        'shadow-intensity': '1',
        style: 'width: 100%; height: 50vh; border-radius: 8px; background: radial-gradient(circle at center, #254d3d 0%, #081610 100%);'
      }));
    } else if (treat.type === 'poll'){
        modalBody.append(el('iframe', {
          src: treat.src,
          width: '100%',
          height: '500',
          style: 'border:none; min-height: 500px;',
          title: 'Poll'
        }))
    }
    else if (treat.type === 'custom') {
    }
     else if (treat.type === 'page' || treat.type === 'game') {
      modalBody.append(el('iframe', { src: treat.src, style:'min-height:60vh' }));
    } else {
      modalBody.append(el('p', {}, 'Unknown treat type.'));
    }

    if (treat.text) {
      const textDiv = document.createElement('div');
      textDiv.className = 'mtext';
      textDiv.innerHTML = treat.text; 
      modalBody.append(textDiv);
    }

    modal.showModal();
    if (treat.specialFeature === 'clap') {
        initClapFeature();
    }
  }

  const jingle = document.getElementById('jingle');
  function onDoorClick(card, treat, unlocked){
    if (!unlocked) return;
    lastOpenedCard = card;
    card.classList.add('open');
    
    if (jingle) jingle.play().catch(()=>{});
    
    if (treat.narration) {
        narrationPlayer.src = treat.narration;
        if (treat.narration === 'narration/day4.mp3') {
            narrationPlayer.volume = 0.05;
        } else if (treat.narration === 'narration/tannenbaum.mp3') {
            narrationPlayer.volume = 0.15;
        } else {
            narrationPlayer.volume = 1.0;
        }
        if(!isMuted) {
            narrationPlayer.play().catch(()=>{});
        }
    }

    setTimeout(()=> showTreat(treat), 600);
  }

  function initClapFeature() {
    const audio = document.getElementById('day5-audio');
    const btn = document.getElementById('clap-btn');
    const sfx = document.getElementById('clap-sfx');

    if (!audio || !btn) return;
    audio.volume = 0.3
    const CLAP_TIME = 220; 

    audio.ontimeupdate = () => {
      if (audio.currentTime >= CLAP_TIME) {
        if (btn.style.display === 'none') {
            btn.style.display = 'inline-flex';
            requestAnimationFrame(() => {
                btn.style.transform = 'scale(1)';
            });
        }
      } else {
        btn.style.transform = 'scale(0)';
        btn.style.display = 'none';
      }
    };
    btn.onclick = () => {
      const soundClone = sfx.cloneNode();
      soundClone.volume = 1;
      soundClone.play().catch(() => {});
      
      btn.style.transform = 'scale(0.9)';
      setTimeout(() => btn.style.transform = 'scale(1)', 100);
    };
  }

  function renderGrid(){
    const grid = document.getElementById('grid');
    grid.innerHTML = '';
    const byDay = new Map(TREAT_DATA.map(t=>[t.day,t]));

    for (let day=1; day<=TOTAL_DOORS; day++){
      const unlocked = isUnlocked(day);
      const treat = byDay.get(day) || { day, type:'page', title:`Day ${day}`, src:`treats/day${day}.html` };
      
      const flap = el('div', { class:'flap' });
      let labelText = `Lucka ${day}`;
      if (unlocked){
        labelText = treat.title || `Lucka ${day}`;
      }
      const content = el('div', { class:'panel' }, [
        el('div', { class:'label' }, labelText)
      ]);
      
      const wrap = unlocked ? el('div', { class: 'gift-wrap' }) : null;

      const inner = el('div', { class:'door'+(unlocked?'':' locked') }, [
        el('div', { class:'num' }, `Lucka ${day}`),
        content, 
        flap,
        wrap
      ]);
      const button = el('button', { class:'reset', 'aria-label': unlocked?`Open day ${day}`:`Day ${day} locked`,
        onClick: ()=> onDoorClick(inner, treat, unlocked)
      });
      inner.appendChild(button);
      grid.append(inner);
    }
  }

  function init(){
    document.getElementById('year').textContent = new Date().getFullYear();
    renderGrid();
  }

  init();

  (function(){
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const canvas = document.getElementById('snowCanvas');
    const rangeSnow = document.getElementById('snowRange');
    const labelSnow = document.getElementById('snowCount');
    const rangeEmoji = document.getElementById('emojiRange');
    const labelEmoji = document.getElementById('emojiCount');

    const laughSwitch = document.getElementById('laughSwitch');
    const laugh = document.getElementById('laugh');
    laughSwitch.addEventListener('change', ()=>{
      if (laughSwitch.checked){ laugh.play().catch(()=>{}); }
      else { laugh.pause(); laugh.currentTime = 0; }
    });

    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    let snow = [];
    let emojis = [];

    let desiredSnow = prefersReduced ? 0 : parseInt(new URLSearchParams(location.search).get('snow')||rangeSnow.value,10);
    let desiredEmoji = parseInt(rangeEmoji.value,10);
    rangeSnow.value = desiredSnow; labelSnow.textContent = desiredSnow;
    labelEmoji.textContent = desiredEmoji;

    const DPR = () => Math.min(window.devicePixelRatio||1, 2);

    function resize(){
      const dpr = DPR();
      const w = Math.floor(window.innerWidth * dpr);
      const h = Math.floor(window.innerHeight * dpr);
      if (canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      ctx.setTransform(dpr,0,0,dpr,0,0); 
    }

    function makeFlake(){
      const w = window.innerWidth, h = window.innerHeight;
      return { x: Math.random()*w, y: Math.random()*h - h, r: Math.random()*2 + 1, vy: Math.random()*0.6 + 0.4, vx: (Math.random()-0.5)*0.6, a: Math.random()*0.4 + 0.6 };
    }
    function makeEmoji(){
      const w = window.innerWidth, h = window.innerHeight;
      return { x: Math.random()*w, y: Math.random()*h - h, s: Math.random()*16 + 18, vy: Math.random()*0.8 + 0.6, vx: (Math.random()-0.5)*0.7, a: 1 };
    }

    function syncCounts(){
      const ds = desiredSnow - snow.length; if (ds>0){ for(let i=0;i<ds;i++) snow.push(makeFlake()); } else if (ds<0){ snow.splice(ds); }
      const de = desiredEmoji - emojis.length; if (de>0){ for(let i=0;i<de;i++) emojis.push(makeEmoji()); } else if (de<0){ emojis.splice(de); }
    }

    let lastT = 0;
    function tick(t){
      if (desiredSnow===0 && desiredEmoji===0){ ctx.clearRect(0,0,canvas.width,canvas.height); requestAnimationFrame(tick); return; }
      const dt = Math.min(33, t - lastT || 16); lastT = t;
      const w = window.innerWidth, h = window.innerHeight;
      ctx.clearRect(0,0,canvas.width,canvas.height);

      ctx.fillStyle = 'rgba(255,255,255,0.9)';
      for (let i=0;i<snow.length;i++){
        const f = snow[i];
        f.y += f.vy * (dt/16); f.x += f.vx * (dt/16);
        if (f.y - f.r > h) { snow[i] = makeFlake(); snow[i].y = -f.r; }
        if (f.x < -10) f.x = w+10; else if (f.x > w+10) f.x = -10;
        ctx.globalAlpha = f.a;
        ctx.beginPath(); ctx.arc(f.x, f.y, f.r, 0, Math.PI*2); ctx.fill();
      }

      const emojiChar = 'üî´';
      ctx.font = '24px system-ui, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji';
      for (let i=0;i<emojis.length;i++){
        const e = emojis[i];
        e.y += e.vy * (dt/16); e.x += e.vx * (dt/16);
        if (e.y - e.s > h) { emojis[i] = makeEmoji(); emojis[i].y = -e.s; }
        if (e.x < -20) e.x = w+20; else if (e.x > w+20) e.x = -20;
        ctx.globalAlpha = 0.95; ctx.font = `${e.s}px system-ui, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji`;
        ctx.fillText(emojiChar, e.x, e.y);
      }

      requestAnimationFrame(tick);
    }

    function initFX(){ resize(); syncCounts(); requestAnimationFrame(tick); }

    window.addEventListener('resize', resize);
    rangeSnow.addEventListener('input', () => { desiredSnow = parseInt(rangeSnow.value, 10); labelSnow.textContent = desiredSnow; syncCounts(); });
    rangeEmoji.addEventListener('input', () => { desiredEmoji = parseInt(rangeEmoji.value, 10); labelEmoji.textContent = desiredEmoji; syncCounts(); });

    const qsSnow = new URLSearchParams(location.search).get('snow');
    if (qsSnow) { desiredSnow = Math.max(0, Math.min(500, parseInt(qsSnow,10)||0)); rangeSnow.value = desiredSnow; labelSnow.textContent = desiredSnow; }

    initFX();
  })();

  // rol the WEEL logic
  const rolWheel = document.getElementById('rolWheel');
  const rolContainer = document.getElementById('rolWidget');
  const rolBubble = document.getElementById('rolBubble');

  if (rolWheel) {
    rolWheel.addEventListener('click', () => {

      rolWheel.classList.add('rol-is-spinning');

      rolContainer.classList.add('rol-is-leaving');

      rolBubble.style.opacity = '0';

      setTimeout(() => {
        rolWheel.src = "wheel/rol_dizzy.png";
      }, 3000);

      setTimeout(() => {
        rolBubble.innerText = "ohh nooo, im rol'ing awaaayy!!!";
        rolBubble.style.opacity = '1';
      }, 8000);
    });
  }

  // mobile logic
  const mobilePollBtn = document.getElementById('mobilePollBtn');
  const mobileRolBtn = document.getElementById('mobileRolBtn');
  const sidePoll = document.getElementById('sidePoll');
  const rolWidget = document.getElementById('rolWidget');

  // helper for widgets
  function toggleMobileWidget(widget) {
    // if open -> close
    if (widget.classList.contains('mobile-active')) {
      widget.classList.remove('mobile-active');
      return;
    }
    // avoiding clutter
    document.querySelectorAll('.mobile-active').forEach(el => el.classList.remove('mobile-active'));
    widget.classList.add('mobile-active');
  }
  if (mobilePollBtn) {
    mobilePollBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMobileWidget(sidePoll);
    });
  }
  if (mobileRolBtn) {
    mobileRolBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMobileWidget(rolWidget);
    });
  }
  document.addEventListener('click', (e) => {
    if (window.innerWidth > 1300) return;

    if (sidePoll.classList.contains('mobile-active') && !sidePoll.contains(e.target) && e.target !== mobilePollBtn) {
      sidePoll.classList.remove('mobile-active');
    }
    if (rolWidget.classList.contains('mobile-active') && !rolWidget.contains(e.target) && e.target !== mobileRolBtn) {
      if (!document.getElementById('rolWheel').classList.contains('rol-is-spinning')) {
        rolWidget.classList.remove('mobile-active');
      }
    }
  });

  </script>
</body>
</html>
